<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Libre Antenne</title>
    <meta
      name="description"
      content="Le chaos en direct : un refuge sans filtre pour drogu√©s, marginaux, alcooliques, gamers et esprits libres."
    />
    <meta name="theme-color" content="#020617" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            boxShadow: {
              glow: '0 0 50px rgba(129, 140, 248, 0.35)',
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      .speaker-card {
        opacity: 0;
        transform: translateY(24px) scale(0.97);
        animation: speaker-fade-in 1.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        will-change: transform, opacity;
      }

      @keyframes speaker-fade-in {
        0% {
          opacity: 0;
          transform: translateY(24px) scale(0.97);
        }

        35% {
          opacity: 0.55;
          transform: translateY(14px) scale(0.985);
        }

        70% {
          opacity: 0.9;
          transform: translateY(4px) scale(1.01);
        }

        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes player-eq {
        0%,
        100% {
          transform: scaleY(0.45);
          opacity: 0.6;
        }

        50% {
          transform: scaleY(1);
          opacity: 1;
        }
      }

      .audio-wave span {
        animation: player-eq 1.2s ease-in-out infinite;
        transform-origin: center bottom;
        display: inline-block;
        width: 0.3rem;
        border-radius: 9999px;
      }

      .audio-wave span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .audio-wave span:nth-child(3) {
        animation-delay: 0.4s;
      }

      .audio-wave span:nth-child(4) {
        animation-delay: 0.6s;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 antialiased">
    <div id="app" class="min-h-screen"></div>

    <script type="module">
      import { h, render, Fragment } from 'https://esm.sh/preact@10.19.2';
      import { useEffect, useMemo, useRef, useState } from 'https://esm.sh/preact@10.19.2/hooks';
      import htm from 'https://esm.sh/htm@3.1.1?deps=preact@10.19.2';

      const html = htm.bind(h);

      const STATUS_LABELS = {
        connecting: {
          label: 'Connexion‚Ä¶',
          ring: 'bg-amber-400/20 text-amber-200 border-amber-400/50',
          dot: 'bg-amber-300',
        },
        connected: {
          label: 'En direct',
          ring: 'bg-emerald-400/15 text-emerald-200 border-emerald-400/40',
          dot: 'bg-emerald-300',
        },
        reconnecting: {
          label: 'Reconnexion‚Ä¶',
          ring: 'bg-sky-400/15 text-sky-200 border-sky-400/40',
          dot: 'bg-sky-300',
        },
        error: {
          label: 'Hors ligne',
          ring: 'bg-rose-500/20 text-rose-100 border-rose-400/50',
          dot: 'bg-rose-300',
        },
      };

      const formatDuration = (ms) => {
        if (!ms || Number.isNaN(ms)) return '';
        const totalSeconds = Math.max(0, Math.round(ms / 1000));
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        if (minutes === 0) return `${seconds}s`;
        if (minutes >= 60) {
          const hours = Math.floor(minutes / 60);
          const remMinutes = minutes % 60;
          return `${hours}h ${remMinutes}m`;
        }
        return `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
      };

      const formatRelative = (timestamp, now) => {
        if (!timestamp) return '‚Äî';
        const diff = Math.max(0, now - timestamp);
        if (diff < 30_000) return 'il y a quelques secondes';
        if (diff < 5 * 60_000) return 'il y a moins de 5 min';
        return new Date(timestamp).toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit',
        });
      };

      const StatusBadge = ({ status }) => {
        const config = STATUS_LABELS[status] ?? STATUS_LABELS.connecting;
        return html`
          <div class=${`flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-medium backdrop-blur ${config.ring}`}>
            <span class=${`h-2.5 w-2.5 rounded-full shadow-md ${config.dot}`}></span>
            <span>${config.label}</span>
          </div>
        `;
      };

      const SpeakerCard = ({ speaker, now }) => {
        const since = speaker.startedAt ? formatDuration(now - speaker.startedAt) : '';
        return html`
          <article
            class="speaker-card group relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-indigo-500/20 via-slate-950 to-fuchsia-500/20 p-5 shadow-xl shadow-indigo-900/30 transition duration-300 hover:border-fuchsia-400/60 hover:shadow-glow"
          >
            <div class="absolute -right-14 -top-14 h-32 w-32 rounded-full bg-fuchsia-500/40 blur-3xl transition-opacity duration-300 group-hover:opacity-100"></div>
            <div class="relative flex items-center gap-5">
              <div class="relative h-20 w-20 flex-shrink-0">
                <div class="absolute inset-0 rounded-full bg-gradient-to-br from-fuchsia-500 via-indigo-400 to-sky-400 opacity-60 blur-xl transition group-hover:opacity-90"></div>
                <img
                  src=${speaker.avatar}
                  alt=${`Avatar de ${speaker.displayName}`}
                  class="relative h-20 w-20 rounded-full border-2 border-white/70 object-cover shadow-lg shadow-fuchsia-900/30"
                  loading="lazy"
                />
                <div class="absolute -bottom-1 -right-1 flex items-center gap-1 rounded-full bg-emerald-500 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wider text-emerald-900 shadow-lg">
                  <span class="relative flex h-2 w-2">
                    <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-200 opacity-75"></span>
                    <span class="relative inline-flex h-2 w-2 rounded-full bg-emerald-800"></span>
                  </span>
                  En live
                </div>
              </div>
              <div class="relative flex flex-1 flex-col gap-2">
                <div class="flex flex-wrap items-baseline gap-2">
                  <h3 class="text-2xl font-semibold text-white">${speaker.displayName}</h3>
                  <span class="text-sm text-slate-300">@${speaker.username}</span>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs text-slate-200">
                  ${since
                    ? html`<span class="flex items-center gap-1 rounded-full bg-white/10 px-3 py-1 backdrop-blur">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="h-3.5 w-3.5"
                        >
                          <circle cx="12" cy="12" r="9"></circle>
                          <path d="M12 7v5l2.5 2.5"></path>
                        </svg>
                        ${since}
                      </span>`
                    : null}
                  <span class="rounded-full bg-white/5 px-3 py-1 uppercase tracking-[0.2em] text-[0.7rem] text-fuchsia-200">
                    En train de parler
                  </span>
                </div>
              </div>
            </div>
          </article>
        `;
      };

      const SpeakersSection = ({ speakers, now }) => {
        if (!speakers.length) {
          return html`
            <div class="mt-6 flex flex-col items-center justify-center gap-4 rounded-3xl border border-white/10 bg-black/40 px-8 py-12 text-center text-sm text-slate-300 backdrop-blur">
              <div class="flex h-14 w-14 items-center justify-center rounded-full bg-white/10 text-fuchsia-200">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-7 w-7"
                >
                  <circle cx="12" cy="12" r="9"></circle>
                  <path d="M12 8v5l3 1.5"></path>
                </svg>
              </div>
              <p class="max-w-sm text-base text-slate-300">
                Personne ne parle pour le moment. Le panneau se mettra √† jour d√®s que quelqu‚Äôun prendra la parole dans le salon.
              </p>
            </div>
          `;
        }

        return html`
          <div class="mt-6 grid gap-6 sm:grid-cols-2">
            ${speakers.map((speaker) => html`<${SpeakerCard} key=${speaker.id} speaker=${speaker} now=${now} />`)}
          </div>
        `;
      };

      const NAV_LINKS = [
        { label: 'Accueil', route: 'home', hash: '#/' },
        { label: '√Ä propos', route: 'about', hash: '#/about' },
      ];

      const getRouteFromHash = () => {
        const hash = window.location.hash.replace(/^#/, '').toLowerCase();
        if (hash === '/about' || hash === 'about') {
          return 'about';
        }
        return 'home';
      };

      const AudioPlayer = ({ streamInfo, audioKey, status }) => {
        const audioRef = useRef(null);
        const [isPlaying, setIsPlaying] = useState(false);
        const [isLoading, setIsLoading] = useState(true);
        const [hasError, setHasError] = useState(false);
        const [isMuted, setIsMuted] = useState(false);
        const [volume, setVolume] = useState(0.75);
        const lastVolumeRef = useRef(0.75);

        const isIgnorablePlayError = (error) => {
          if (!error) return false;
          const name = error.name || '';
          return name === 'AbortError' || name === 'NotAllowedError';
        };

        useEffect(() => {
          const audio = audioRef.current;
          if (!audio) return undefined;

          const handlePlaying = () => {
            setIsPlaying(true);
            setIsLoading(false);
            setHasError(false);
          };

          const handleWaiting = () => {
            if (!audio.paused) {
              setIsLoading(true);
            }
          };

          const handlePause = () => {
            setIsPlaying(false);
            setIsLoading(false);
          };

          const handleCanPlay = () => {
            setIsLoading(false);
          };

          const handleError = () => {
            setHasError(true);
            setIsPlaying(false);
            setIsLoading(false);
          };

          const handleEnded = () => {
            setIsPlaying(false);
          };

          audio.addEventListener('playing', handlePlaying);
          audio.addEventListener('waiting', handleWaiting);
          audio.addEventListener('pause', handlePause);
          audio.addEventListener('canplay', handleCanPlay);
          audio.addEventListener('canplaythrough', handleCanPlay);
          audio.addEventListener('stalled', handleWaiting);
          audio.addEventListener('suspend', handleWaiting);
          audio.addEventListener('error', handleError);
          audio.addEventListener('ended', handleEnded);

          return () => {
            audio.removeEventListener('playing', handlePlaying);
            audio.removeEventListener('waiting', handleWaiting);
            audio.removeEventListener('pause', handlePause);
            audio.removeEventListener('canplay', handleCanPlay);
            audio.removeEventListener('canplaythrough', handleCanPlay);
            audio.removeEventListener('stalled', handleWaiting);
            audio.removeEventListener('suspend', handleWaiting);
            audio.removeEventListener('error', handleError);
            audio.removeEventListener('ended', handleEnded);
          };
        }, []);

        useEffect(() => {
          const audio = audioRef.current;
          if (!audio) return;
          audio.volume = Math.min(1, Math.max(0, volume));
        }, [volume]);

        useEffect(() => {
          const audio = audioRef.current;
          if (!audio) return;
          audio.muted = isMuted;
        }, [isMuted]);

        useEffect(() => {
          const audio = audioRef.current;
          if (!audio) return;

          setHasError(false);

          if (!audio.paused) {
            audio.pause();
          }
          audio.src = streamInfo.path;
          audio.load();
          setIsLoading(true);

          const attemptPlay = async () => {
            try {
              await audio.play();
            } catch (error) {
              console.warn('Lecture automatique bloqu√©e', error);
              setIsLoading(false);
            }
          };

          attemptPlay();

          return () => {
            audio.pause();
          };
        }, [audioKey, streamInfo.path]);

        const togglePlay = () => {
          const audio = audioRef.current;
          if (!audio) return;

          if (hasError) {
            setHasError(false);
          }

          if (isPlaying) {
            audio.pause();
          } else {
            setIsLoading(true);
            audio
              .play()
              .catch((error) => {
                if (isIgnorablePlayError(error)) {
                  setIsLoading(false);
                  return;
                }
                console.error('Impossible de lancer la lecture', error);
                setHasError(true);
                setIsLoading(false);
              });
          }
        };

        const handleRetry = () => {
          const audio = audioRef.current;
          if (!audio) return;

          setHasError(false);
          setIsLoading(true);

          if (!audio.paused) {
            audio.pause();
          }
          audio.src = streamInfo.path;
          audio.load();
          audio
            .play()
            .catch((error) => {
              if (isIgnorablePlayError(error)) {
                setIsLoading(false);
                return;
              }
              console.error('La relance du flux a √©chou√©', error);
              setHasError(true);
              setIsLoading(false);
            });
        };

        const handleVolumeChange = (event) => {
          const value = Number(event?.target?.value ?? 0) / 100;
          const nextVolume = Number.isFinite(value) ? Math.min(1, Math.max(0, value)) : 0;
          setVolume(nextVolume);
          if (nextVolume === 0) {
            setIsMuted(true);
          } else {
            lastVolumeRef.current = nextVolume;
            if (isMuted) {
              setIsMuted(false);
            }
          }
        };

        const toggleMute = () => {
          if (isMuted || volume === 0) {
            const restored = lastVolumeRef.current > 0 ? lastVolumeRef.current : 0.5;
            setVolume(restored);
            setIsMuted(false);
          } else {
            lastVolumeRef.current = volume > 0 ? volume : lastVolumeRef.current;
            setIsMuted(true);
          }
        };

        const renderVolumeIcon = () => {
          if (hasError) {
            return html`
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3v.008h.008V15H12z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0Z" />
              </svg>
            `;
          }

          if (isMuted || volume === 0) {
            return html`
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19 5-6 6m0 0-6 6m6-6 6 6m-6-6-6-6" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 9v6h3.586L13 18.414V5.586L7.586 11H4Z" />
              </svg>
            `;
          }

          if (volume < 0.45) {
            return html`
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 9v6h3.586L13 18.414V5.586L7.586 11H4Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 9.75a2.25 2.25 0 0 1 0 4.5" />
              </svg>
            `;
          }

          return html`
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 9v6h3.586L13 18.414V5.586L7.586 11H4Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25a3.75 3.75 0 0 1 0 7.5" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 6a6 6 0 0 1 0 12" />
            </svg>
          `;
        };

        const statusConfig = STATUS_LABELS[status] ?? STATUS_LABELS.connecting;
        const statusText = hasError
          ? 'Flux indisponible. Relance le flux pour r√©essayer.'
          : isLoading
          ? 'Connexion au flux‚Ä¶'
          : isPlaying
          ? 'Lecture en cours'
          : 'En pause';

        return html`
          <div class="relative mt-6 overflow-hidden rounded-2xl border border-white/10 bg-slate-950/80 p-6 shadow-2xl shadow-slate-950/60 backdrop-blur">
            <div class="pointer-events-none absolute -left-32 top-[-8rem] h-72 w-72 rounded-full bg-fuchsia-500/25 blur-3xl"></div>
            <div class="pointer-events-none absolute -right-36 bottom-[-10rem] h-80 w-80 rounded-full bg-indigo-500/25 blur-[110px]"></div>
            <div class="relative flex flex-col gap-6 xl:flex-row xl:items-center xl:justify-between">
              <div class="flex flex-1 flex-col gap-4 sm:flex-row sm:items-center">
                <div class="flex items-center gap-5">
                  <button
                    type="button"
                    class="relative flex h-18 w-32 items-center justify-center rounded-full bg-gradient-to-br from-fuchsia-500 via-indigo-500 to-sky-400 text-white shadow-lg shadow-fuchsia-900/40 transition focus:outline-none focus:ring-2 focus:ring-fuchsia-300 focus:ring-offset-2 focus:ring-offset-slate-950 hover:scale-105 disabled:cursor-not-allowed disabled:opacity-60"
                    aria-label=${isPlaying ? 'Mettre le flux en pause' : 'Lancer la lecture du flux'}
                    onClick=${togglePlay}
                    disabled=${isLoading && !isPlaying && !hasError}
                  >
                    ${
                      hasError
                        ? html`
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-7 w-7">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3v.008h.008V15H12Z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0Z" />
                            </svg>
                          `
                        : isLoading && !isPlaying
                        ? html`<span class="h-6 w-6 animate-spin rounded-full border-2 border-white/70 border-t-transparent"></span>`
                        : isPlaying
                        ? html`
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="h-7 w-7">
                              <path d="M9 5h3v14H9zM15 5h3v14h-3z" />
                            </svg>
                          `
                        : html`
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="h-7 w-7">
                              <path d="M8 5v14l11-7z" />
                            </svg>
                          `
                    }
                  </button>
                  <div class="space-y-3">
                    <div class="flex flex-wrap items-center gap-3">
                      <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200">
                        <span class="relative flex h-2 w-2">
                          <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-200 opacity-75"></span>
                          <span class="relative inline-flex h-2 w-2 rounded-full bg-emerald-700"></span>
                        </span>
                        En direct
                      </span>
                      <span class="rounded-full border border-white/10 bg-white/10 px-3 py-1 text-[0.7rem] font-medium uppercase tracking-[0.35em] text-slate-200">
                        ${statusConfig.label}
                      </span>
                      ${
                        isPlaying
                          ? html`<div class="audio-wave flex items-end gap-1 text-fuchsia-200">
                              <span class="h-4 bg-current"></span>
                              <span class="h-6 bg-current"></span>
                              <span class="h-5 bg-current"></span>
                              <span class="h-7 bg-current"></span>
                            </div>`
                          : null
                      }
                    </div>
                    <p class="text-sm text-slate-200">
                      Libre Antenne diffuse le salon vocal en continu. Branche-toi et profite du chaos.
                    </p>
                    <p class=${`text-xs font-medium ${hasError ? 'text-rose-200' : 'text-slate-300'}`}>${statusText}</p>
                  </div>
                </div>
              </div>
              <div class="relative w-full max-w-md rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur">
                <div class="flex flex-wrap items-center justify-between gap-2 text-[0.65rem] uppercase tracking-[0.35em] text-slate-300">
                  <span class="rounded-full border border-fuchsia-400/30 bg-fuchsia-500/10 px-3 py-1 text-fuchsia-100">
                    ${streamInfo.format === 'mp3' ? 'MP3' : 'OPUS'}
                  </span>
                  <span class="truncate text-[0.6rem] text-slate-400">Endpoint¬†: ${streamInfo.path}</span>
                </div>
                <div class="mt-4 flex items-center gap-3">
                  <button
                    type="button"
                    class="flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-slate-200 transition hover:border-white/30 hover:bg-white/10 hover:text-white focus:outline-none focus:ring-2 focus:ring-fuchsia-300 focus:ring-offset-2 focus:ring-offset-slate-950"
                    aria-label=${isMuted || volume === 0 ? 'Activer le son' : 'Couper le son'}
                    onClick=${toggleMute}
                  >
                    ${renderVolumeIcon()}
                  </button>
                  <input
                    type="range"
                    min="0"
                    max="100"
                    step="1"
                    value=${Math.round(volume * 100)}
                    onInput=${handleVolumeChange}
                    class="h-1 flex-1 cursor-pointer appearance-none rounded-full bg-white/20 accent-fuchsia-400 focus:outline-none focus:ring-0"
                    aria-label="Volume"
                  />
                  <span class="w-12 text-right text-xs text-slate-300">${Math.round(volume * 100)}%</span>
                </div>
              </div>
            </div>
            ${
              hasError
                ? html`<div class="relative mt-5 flex flex-wrap items-center gap-3 rounded-2xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-100">
                    <div class="flex items-center gap-2 font-semibold">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3v.008h.008V15H12Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0Z" />
                      </svg>
                      Flux indisponible
                    </div>
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-rose-200/40 bg-rose-200/10 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-rose-100 transition hover:bg-rose-200/20"
                      onClick=${handleRetry}
                    >
                      Relancer le flux
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992V4.356" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-3.338-6.961" />
                      </svg>
                    </button>
                  </div>`
                : null
            }
            <audio ref=${audioRef} preload="auto" playsinline crossorigin="anonymous" aria-hidden="true"></audio>
          </div>
        `;
      };

      const HomePage = ({ status, lastUpdateLabel, streamInfo, audioKey, speakers, now }) => html`
        <${Fragment}>
          <section
            class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/5 px-8 py-12 shadow-xl shadow-slate-950/50 backdrop-blur-xl"
          >
            <div class="pointer-events-none absolute -right-24 -top-24 h-64 w-64 rounded-full bg-fuchsia-500/25 blur-3xl"></div>
            <div class="relative flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
              <div class="space-y-4">
                <p class="text-xs uppercase tracking-[0.35em] text-slate-300">Libre Antenne</p>
                <h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl">Libre Antenne</h1>
                <p class="max-w-xl text-base text-slate-200">
                  Le chaos en direct : un refuge sans filtre pour drogu√©s, marginaux, alcooliques, gamers et esprits libres.
                </p>
                <a
                  class="inline-flex items-center gap-2 rounded-full border border-fuchsia-400/60 bg-fuchsia-500/20 px-5 py-2 text-sm font-semibold text-fuchsia-100 shadow-lg shadow-fuchsia-900/40 transition hover:bg-fuchsia-500/30 hover:text-white"
                  href="https://discord.gg/btjTZ5C"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Rejoindre le Discord
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="h-4 w-4"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 12h13.5m0 0-5.25-5.25M18.75 12l-5.25 5.25" />
                  </svg>
                </a>
              </div>
              <div class="flex flex-col items-start gap-3 text-left lg:items-end lg:text-right">
                <${StatusBadge} status=${status} />
                <p class="text-xs text-slate-300">Derni√®re mise √† jour¬†: ${lastUpdateLabel}</p>
              </div>
            </div>
          </section>

          <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl">
            <div class="pointer-events-none absolute -right-20 bottom-0 h-56 w-56 rounded-full bg-indigo-400/30 blur-3xl"></div>
            <div class="relative flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
              <div class="space-y-2">
                <h2 class="text-2xl font-semibold text-white">Flux audio en direct</h2>
                <p class="text-sm text-slate-300">
                  Clique sur lecture si le flux ne d√©marre pas automatiquement. Volume conseill√©¬†: casque üíú
                </p>
              </div>
            </div>
            <${AudioPlayer} streamInfo=${streamInfo} audioKey=${audioKey} status=${status} />
          </section>

          <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-2xl font-semibold text-white">Intervenants en temps r√©el</h2>
                <p class="text-sm text-slate-300">
                  Les avatars s‚Äôaniment instantan√©ment lorsqu‚Äôune voix est d√©tect√©e sur le salon.
                </p>
              </div>
              <div class="flex items-center gap-2 rounded-full border border-white/10 bg-black/40 px-4 py-1.5 text-xs uppercase tracking-[0.3em] text-indigo-200">
                <span class="h-2 w-2 rounded-full bg-indigo-300"></span>
                ${speakers.length} en direct
              </div>
            </div>
            <${SpeakersSection} speakers=${speakers} now=${now} />
          </section>
        </${Fragment}>
      `;

      const AboutPage = () => html`
        <${Fragment}>
          <section class="space-y-6 rounded-3xl border border-white/10 bg-white/5 px-8 py-12 shadow-xl shadow-slate-950/40 backdrop-blur-xl">
            <p class="text-xs uppercase tracking-[0.35em] text-slate-300">Libre Antenne</p>
            <h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl">√Ä propos de Libre Antenne</h1>
            <p class="text-base leading-relaxed text-slate-200">
              Libre Antenne est une zone franche o√π les voix prennent le pouvoir. Le flux est volontairement brut,
              capt√© en direct sur notre serveur Discord pour amplifier les histoires, les confidences et les improvisations qui
              naissent.
            </p>
            <p class="text-base leading-relaxed text-slate-200">
              Notre √©quipe fa√ßonne un espace accueillant pour les marginaux cr√©atifs, les gamers insomniaques et toutes les
              personnes qui ont besoin d‚Äôun micro ouvert. Ici, aucune intervention n‚Äôest script√©e¬†: la seule r√®gle est de
              respecter la vibe collective et de laisser la spontan√©it√© guider la conversation.
            </p>
          </section>

          <section class="grid gap-6 md:grid-cols-2">
            <div class="rounded-3xl border border-white/10 bg-slate-950/60 p-6 shadow-lg shadow-slate-950/40 backdrop-blur">
              <h2 class="text-xl font-semibold text-white">Un laboratoire</h2>
              <p class="mt-3 text-sm text-slate-300">
                Sessions freestyle, confessions lunaires, d√©bats improvis√©s¬†: chaque passage est un moment unique fa√ßonn√© par la
                communaut√©. Le direct nous permet de capturer cette √©nergie sans filtre.
              </p>
            </div>
            <div class="rounded-3xl border border-white/10 bg-slate-950/60 p-6 shadow-lg shadow-slate-950/40 backdrop-blur">
              <h2 class="text-xl font-semibold text-white">Technologie artisanale</h2>
              <p class="mt-3 text-sm text-slate-300">
                Notre mixeur audio fait circuler chaque voix avec finesse. Les outils open source et les contributions des
                membres permettent d‚Äôam√©liorer constamment la qualit√© du flux.
              </p>
            </div>
            <div class="rounded-3xl border border-white/10 bg-slate-950/60 p-6 shadow-lg shadow-slate-950/40 backdrop-blur">
              <h2 class="text-xl font-semibold text-white">Communaut√© inclusive</h2>
              <p class="mt-3 text-sm text-slate-300">
                Peu importe ton accent, ton parcours ou ton rythme de vie¬†: tu es accueilli¬∑e tant que tu joues collectif et que
                tu respectes les autres intervenants.
              </p>
            </div>
            <div class="rounded-3xl border border-white/10 bg-slate-950/60 p-6 shadow-lg shadow-slate-950/40 backdrop-blur">
              <h2 class="text-xl font-semibold text-white">Programmation souple</h2>
              <p class="mt-3 text-sm text-slate-300">
                Les cr√©neaux sont ouverts¬†: tu peux proposer un sujet, lancer un atelier ou simplement √©couter. Le planning
                √©volue selon les envies du moment.
              </p>
            </div>
          </section>

          <section class="rounded-3xl border border-fuchsia-500/30 bg-fuchsia-500/10 px-8 py-10 text-center shadow-xl shadow-fuchsia-900/30 backdrop-blur">
            <h2 class="text-2xl font-semibold text-white">Rejoins la fr√©quence</h2>
            <p class="mt-3 text-sm text-fuchsia-100">
              Connecte-toi sur Discord pour proposer ta voix, √©couter les autres et faire grandir l‚Äôexp√©rience Libre Antenne.
              La sc√®ne t‚Äôattend.
            </p>
            <a
              class="mt-6 inline-flex items-center gap-2 rounded-full border border-white/40 bg-white/10 px-5 py-2 text-sm font-semibold text-white transition hover:bg-white/20"
              href="https://discord.gg/btjTZ5C"
              target="_blank"
              rel="noopener noreferrer"
            >
              Rejoindre le Discord
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="h-4 w-4"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 12h13.5m0 0-5.25-5.25M18.75 12l-5.25 5.25" />
              </svg>
            </a>
          </section>
        </${Fragment}>
      `;

      const App = () => {
        const [status, setStatus] = useState('connecting');
        const [speakersMap, setSpeakersMap] = useState(() => new Map());
        const [streamInfo, setStreamInfo] = useState({ path: '/stream', format: 'opus', mimeType: 'audio/ogg' });
        const [lastUpdate, setLastUpdate] = useState(null);
        const [now, setNow] = useState(Date.now());
        const [menuOpen, setMenuOpen] = useState(false);
        const [route, setRoute] = useState(() => getRouteFromHash());

        useEffect(() => {
          const id = setInterval(() => setNow(Date.now()), 1000);
          return () => clearInterval(id);
        }, []);

        useEffect(() => {
          if (!window.location.hash) {
            window.location.hash = '/';
          }
        }, []);

        useEffect(() => {
          const updateRoute = () => setRoute(getRouteFromHash());
          window.addEventListener('hashchange', updateRoute);
          return () => window.removeEventListener('hashchange', updateRoute);
        }, []);

        useEffect(() => {
          setMenuOpen(false);
        }, [route]);

        useEffect(() => {
          const source = new EventSource('/events');
          source.onopen = () => setStatus('connected');
          source.onerror = () => {
            if (source.readyState === EventSource.CONNECTING) {
              setStatus('reconnecting');
            } else if (source.readyState === EventSource.CLOSED) {
              setStatus('error');
            }
          };

          const applyState = (payload) => {
            if (!payload || !Array.isArray(payload.speakers)) return;
            setSpeakersMap(() => {
              const map = new Map();
              for (const speaker of payload.speakers) {
                map.set(speaker.id, speaker);
              }
              return map;
            });
            setLastUpdate(Date.now());
          };

          source.addEventListener('state', (event) => {
            try {
              const data = JSON.parse(event.data);
              applyState(data);
            } catch (err) {
              console.error('state event parse error', err);
            }
          });

          source.addEventListener('speaking', (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data?.type === 'start' && data.user) {
                setSpeakersMap((prev) => {
                  const next = new Map(prev);
                  next.set(data.user.id, data.user);
                  return next;
                });
              } else if (data?.type === 'end' && data.userId) {
                setSpeakersMap((prev) => {
                  if (!prev.has(data.userId)) return prev;
                  const next = new Map(prev);
                  next.delete(data.userId);
                  return next;
                });
              }
              setLastUpdate(Date.now());
            } catch (err) {
              console.error('speaking event parse error', err);
            }
          });

          source.addEventListener('info', (event) => {
            try {
              const data = JSON.parse(event.data);
              setStreamInfo((prev) => ({
                path: data?.path ?? prev.path,
                format: data?.format ?? prev.format,
                mimeType: data?.mimeType ?? prev.mimeType,
              }));
            } catch (err) {
              console.error('info event parse error', err);
            }
          });

          return () => source.close();
        }, []);

        const speakers = useMemo(
          () => Array.from(speakersMap.values()).sort((a, b) => (a.startedAt || 0) - (b.startedAt || 0)),
          [speakersMap]
        );

        const lastUpdateLabel = lastUpdate ? formatRelative(lastUpdate, now) : 'Synchronisation‚Ä¶';
        const audioKey = `${streamInfo.path}|${streamInfo.mimeType}`;

        const handleNavigate = (event, targetRoute) => {
          event.preventDefault();
          const targetHash = targetRoute === 'home' ? '#/' : '#/about';
          if (window.location.hash !== targetHash) {
            window.location.hash = targetHash;
          } else {
            setRoute(targetRoute);
          }
          setMenuOpen(false);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        return html`
          <div class="relative flex min-h-screen flex-col overflow-hidden">
            <div class="pointer-events-none absolute inset-0 overflow-hidden">
              <div class="absolute -left-24 -top-24 h-[24rem] w-[24rem] rounded-full bg-indigo-500/30 blur-3xl"></div>
              <div class="absolute -right-20 bottom-[-8rem] h-[28rem] w-[28rem] rounded-full bg-fuchsia-500/25 blur-[120px]"></div>
              <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(99,102,241,0.08)_0,_transparent_55%)]"></div>
            </div>
            <div class="relative z-10 flex flex-1 flex-col">
              <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/70 backdrop-blur">
                <div class="mx-auto flex max-w-5xl items-center justify-between px-6 py-4 sm:px-10">
                  <a
                    href="#/"
                    class="text-base font-semibold uppercase tracking-[0.35em] text-slate-200 transition hover:text-white"
                    onClick=${(event) => handleNavigate(event, 'home')}
                  >
                    Libre Antenne
                  </a>
                  <nav class="hidden items-center gap-6 md:flex">
                    ${NAV_LINKS.map((link) =>
                      html`
                        <a
                          key=${link.route}
                          href=${link.hash}
                          onClick=${(event) => handleNavigate(event, link.route)}
                          aria-current=${route === link.route ? 'page' : undefined}
                          class=${`text-sm font-semibold transition hover:text-white ${
                            route === link.route ? 'text-white' : 'text-slate-300'
                          }`}
                        >
                          ${link.label}
                        </a>
                      `
                    )}
                  </nav>
                  <button
                    type="button"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/20 bg-white/5 text-slate-200 transition hover:border-white/40 hover:text-white md:hidden"
                    aria-label=${menuOpen ? 'Fermer le menu' : 'Ouvrir le menu'}
                    aria-expanded=${menuOpen}
                    onClick=${() => setMenuOpen((prev) => !prev)}
                  >
                    ${
                      menuOpen
                        ? html`
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke-width="1.5"
                              stroke="currentColor"
                              class="h-5 w-5"
                            >
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          `
                        : html`
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke-width="1.5"
                              stroke="currentColor"
                              class="h-5 w-5"
                            >
                              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                          `
                    }
                  </button>
                </div>
                ${
                  menuOpen
                    ? html`
                        <div class="border-t border-white/10 px-6 pb-6 pt-4 sm:px-10 md:hidden">
                          <nav class="flex flex-col gap-3">
                            ${NAV_LINKS.map((link) =>
                              html`
                                <a
                                  key=${`mobile-${link.route}`}
                                  href=${link.hash}
                                  onClick=${(event) => handleNavigate(event, link.route)}
                                  class=${`rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold transition hover:bg-white/10 hover:text-white ${
                                    route === link.route ? 'text-white' : 'text-slate-200'
                                  }`}
                                >
                                  ${link.label}
                                </a>
                              `
                            )}
                          </nav>
                        </div>
                      `
                    : null
                }
              </header>

              <main class="flex-1 px-6 pb-16 pt-8 sm:px-10">
                <div class="mx-auto flex max-w-5xl flex-col gap-10">
                  ${
                    route === 'about'
                      ? html`<${AboutPage} />`
                      : html`<${HomePage}
                          status=${status}
                          lastUpdateLabel=${lastUpdateLabel}
                          streamInfo=${streamInfo}
                          audioKey=${audioKey}
                          speakers=${speakers}
                          now=${now}
                        />`
                  }
                </div>
              </main>

              <footer class="px-6 pb-10 text-center text-xs text-slate-500 sm:px-10">
                Libre Antenne ¬∑ Tous droits r√©serv√©s
              </footer>
            </div>
          </div>
        `;
      };

      render(html`<${App} />`, document.getElementById('app'));
    </script>
  </body>
</html>
